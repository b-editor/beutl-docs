> [!WARNING]
> - 後で分かりやすく編集します。
> - サンプルコードはとりあえず書いてみただけなので、動くかわからないです。
>   実際に動くコードは https://github.com/b-editor/Beutl.Sample.Extension や https://github.com/b-editor/beutl/tree/main/tests/PackageSample をご確認ください。


# 拡張機能

拡張機能の開発方法です。

**必要な知識**
- .NET

**UIをつかった拡張機能に必要な知識**
- Avalonia
- MVVM
- Reactive Extension
- ReactiveProperty

## プロジェクトの初期化
1. dotnet-sdk-7.0をインストールします。
2. クラスライブラリを作成します。  
`dotnet new classlib -o MyBeutlExtension`
3. 生成された、`MyBeutlExtension/MyBeutlExtension.csproj`を以下のようにします。
```xml
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net7.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>

    <!-- 以下は任意です。 -->
    <RepositoryUrl>url/to/repository</RepositoryUrl>
    <PackageId>MyBeutlExtension</PackageId>
    <Title>拡張機能のサンプル</Title>
    <Description>サンプル</Description>
    <PackageTags>sample</PackageTags>
    <Version>1.0.0</Version>
    <AssemblyVersion>1.0.0.0</AssemblyVersion>
    <Authors>作者名</Authors>
  </PropertyGroup>

  <!-- ビルドしたときに、サイドロード拡張機能として認識されるようにする。 -->
  <PropertyGroup Condition="'$(Configuration)'=='Debug'">
    <AppendTargetFrameworkToOutputPath>false</AppendTargetFrameworkToOutputPath>
    <AppendRuntimeIdentifierToOutputPath>false</AppendRuntimeIdentifierToOutputPath>
    <EnableDynamicLoading>true</EnableDynamicLoading>
    <OutputPath>$([System.Environment]::GetFolderPath(SpecialFolder.UserProfile))\.beutl\sideloads\$(AssemblyName)</OutputPath>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Beutl.Sdk" Version="1.0.0" />
  </ItemGroup>

</Project>
```
4. `.nuget`ディレクトリを作成します。
5. `Beutl.Sdk.nupkg`をダウンロードして、`.nuget`に移動します。
6. nuget.configを生成します。
`dotnet new nugetconfig`
7. 生成されたnuget.configにローカルのパッケージソースを追加します。
`dotnet nuget add source .nuget -n ローカルソース`

## 機能を追加
Beutlでは以下の機能を拡張できます。

| 型名 | 説明 |
| --- | --- |
| DecodingExtension | 動画、音声の対応、入力ファイルを追加します |
| EncodingExtension | 動画、音声の対応、出力ファイルを追加します |
| EditorExtension | ファイルの編集UIを追加します |
| OutputExtension | 出力UIを追加します。 |
| Extension | 拡張機能のベースクラス (Loadメソッドをoverrideして機能を登録できる) |
| PageExtension | ウィンドウの左側のメニューから選択できるページを追加します |
| ProjectItemExtension | プロジェクトのアイテムの種類を追加します |
| PropertyEditorExtension | プロパティの特定の型の編集UIを追加します |
| [ToolTabExtension](#ToolTabExtension) | シーンの編集画面にタブを追加します |

## サンプル

### ToolTabExtension
```cs
using Avalonia.Controls;
using Beutl.Extensibility;
using Microsoft.Extensions.DependencyInjection;
using Reactive.Bindings;
using Reactive.Bindings.Extensions;

namespsce MyBeutlExtension;

// 拡張機能としてエクスポート
// Export属性は'Beutl.Extensibility.ExportAttribute'を使用してください。
// MEFのExport属性ではありません。
[Export]
public class SampleToolTabExtension : ToolTabExtension
{
    public override string Name => "Sample tool";
    public override string DisplayName => "Sample tool";
    // 複数のタブを開けるか
    public override bool CanMultiple => true;

    // コントロールを作成します
    public override bool TryCreateContent(
        IEditorContext editorContext,
        [NotNullWhen(true)] out Control? control)
    {
        // 条件は TryCreateContext と同じにします。
        if (editorContext.GetService<Scene>() is { })
        {
            context = new SampleToolTabView();
            return true;
        }
        else
        {
            context = null;
            return false;
        }
    }

    public override bool TryCreateContext(
        IEditorContext editorContext,
        [NotNullWhen(true)] out IToolContext? context)
    {
        // Sceneクラスが必要。
        // GetServiceからNullが返ってきた場合、IEditorContextはSceneに関係づけられていない
        if (editorContext.GetService<Scene>() is Scene scene)
        {
            context = new SampleToolTabViewModel(scene, this);
            return true;
        }
        else
        {
            context = null;
            return false;
        }
    }
}

public sealed class SampleToolTabViewModel　: IToolContext
{
    private readonly CompositeDisposable _disposable = new();
    private Scene _scene;

    public SampleToolTabViewModel(Scene scene, SampleToolTabExtension extension)
    {
        Extension = extension;
        _scene = scene;
        Period = new ReactivePropertySlim(1);
        CurrentFrame = scene.GetObservabke(Scene.CurrentFrameProperty)
            .ToReadOnlyReactivePropertySlim()
            .DisposeWith(_disposable);
            
        // Period秒毎に、一周
        const double MaxAngle = 360;
        Angle = CurrentFrame.CombineLatest(Period.Where(p => p > 0))
            .Select(t => (t.First.TotalSeconds % t.Second) / t.Second) // tは(TimeSpan First, double Second)型です。
            .Select(r => r * MaxAngle)
            .ToReadOnlyReactivePropertySlim()
            .DisposeWith(_disposable);
    }
    
    public ReadOnlyReactivePropertySlim<TimeSpan> CurrentFrame { get; }
    // 周期 (何秒で一周)
    public ReactivePropertySlim<double> Period { get; }
    // 角度
    public ReadOnlyReactivePropertySlim<double> Angle { get; }

    // IToolContextの実装
    public ToolTabExtension Extension { get; }
    // タブが選択されているかのプロパティ、初期状態にtrueを指定しないで下さい
    public IReactiveProperty<bool> IsSelected { get; } = new ReactiveProperty<bool>();
    // 表示するタブ名
    public string Header => "サンプル";
    // 右側に配置
    public ToolTabExtension.TabPlacement Placement => ToolTabExtension.TabPlacement.Right;
    
    // IDisposableの実装
    public void Dispose()
    {
        _disposable.Dispose();
        // 意味があるとは思えないが、一応nullを代入。
        // '!'はnullable対策
        _scene = null!;
    }
    
    // IJsonSerializableの実装
    // UIの状態を保存、復元します。
    // IsSelectedプロパティは保存しないで下さい
    public void ReadFromJson(JsonObject obj)
    {
        if ((obj[nameof(Period)] as JsonValue)?.TryGetValue(out double value) == true)
        {
            Period.Value = value;
        }
    }
    
    public void WriteToJson(JsonObject obj)
    {
        obj[nameof(Period)] = Period.Value;
    }
    
    // IServiceProviderの実装
    public object? GetService(Type type)
    {
        return null;
    }
}

public partial class SampleToolTabView : UserControl
{
    public SampleToolTabView()
    {
        InitializeComponent():
    }
}
```
```xml
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:local="using:MyBeutlExtension"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:DataType="local:SampleToolTabViewModel"
             x:CompileBindings="True"
             x:Class="MyBeutlExtension.SampleToolTabView">
  <Arc x:Name="arc"
       SweepAngle="{Binding Angle.Value}"
       Stroke="{DynamicResource SystemAccentColor}"
       StrokeAlignment="10" />
</UserControl>
```